#| title: "SIR Model"
#| dataset-name: "sir_model_fit"
#| description: "An example SIR model that has been fit to COVID-19 data from Thailand. You'll need to be careful with dates and times, to make sure you're only plotting histograms on whole days, but an otherwise continuous line. Caution with gaps between bars, and an alpha"
#| colours: "`c('#E74C3C', '#2C3E50', 'gray40')`"

library(ggplot2)
library(dplyr)

incidence <- data.frame(
    Date = as.Date(c(
        "2020-03-07", "2020-03-08", "2020-03-09", "2020-03-10", "2020-03-11",
        "2020-03-12", "2020-03-13", "2020-03-14", "2020-03-15", "2020-03-16",
        "2020-03-17", "2020-03-18", "2020-03-19", "2020-03-20", "2020-03-21",
        "2020-03-22", "2020-03-23", "2020-03-24", "2020-03-25", "2020-03-26"
    )),
    Cases = c(
        2, 0, 0, 3, 6, 11, 5, 7, 32, 33,
        30, 35, 60, 50, 89, 188, 122, 106, 107, 111
    ),
    Cumulative_cases = c(
        50, 50, 50, 53, 59, 70, 75, 82, 114, 147,
        177, 212, 272, 322, 411, 599, 721, 827, 934, 1045
    ),
    stringsAsFactors = FALSE
)


sir_model_fit <- data.frame(
    day = as.Date(c(
        "2020-03-07", "2020-03-07", "2020-03-07",
        "2020-03-07", "2020-03-07", "2020-03-07", "2020-03-07",
        "2020-03-07", "2020-03-07", "2020-03-07", "2020-03-08", "2020-03-08",
        "2020-03-08", "2020-03-08", "2020-03-08", "2020-03-08",
        "2020-03-08", "2020-03-08", "2020-03-08", "2020-03-08", "2020-03-09",
        "2020-03-09", "2020-03-09", "2020-03-09", "2020-03-09",
        "2020-03-09", "2020-03-09", "2020-03-09", "2020-03-09", "2020-03-09",
        "2020-03-10", "2020-03-10", "2020-03-10", "2020-03-10",
        "2020-03-10", "2020-03-10", "2020-03-10", "2020-03-10", "2020-03-10",
        "2020-03-10", "2020-03-11", "2020-03-11", "2020-03-11",
        "2020-03-11", "2020-03-11", "2020-03-11", "2020-03-11", "2020-03-11",
        "2020-03-11", "2020-03-11", "2020-03-12", "2020-03-12",
        "2020-03-12", "2020-03-12", "2020-03-12", "2020-03-12", "2020-03-12",
        "2020-03-12", "2020-03-12", "2020-03-12", "2020-03-13",
        "2020-03-13", "2020-03-13", "2020-03-13", "2020-03-13", "2020-03-13",
        "2020-03-13", "2020-03-13", "2020-03-13", "2020-03-13",
        "2020-03-14", "2020-03-14", "2020-03-14", "2020-03-14", "2020-03-14",
        "2020-03-14", "2020-03-14", "2020-03-14", "2020-03-14",
        "2020-03-14", "2020-03-15", "2020-03-15", "2020-03-15", "2020-03-15",
        "2020-03-15", "2020-03-15", "2020-03-15", "2020-03-15",
        "2020-03-15", "2020-03-15", "2020-03-16", "2020-03-16", "2020-03-16",
        "2020-03-16", "2020-03-16", "2020-03-16", "2020-03-16",
        "2020-03-16", "2020-03-16", "2020-03-16", "2020-03-17", "2020-03-17",
        "2020-03-17", "2020-03-17", "2020-03-17", "2020-03-17",
        "2020-03-17", "2020-03-17", "2020-03-17", "2020-03-17", "2020-03-18",
        "2020-03-18", "2020-03-18", "2020-03-18", "2020-03-18",
        "2020-03-18", "2020-03-18", "2020-03-18", "2020-03-18", "2020-03-18",
        "2020-03-19", "2020-03-19", "2020-03-19", "2020-03-19",
        "2020-03-19", "2020-03-19", "2020-03-19", "2020-03-19", "2020-03-19",
        "2020-03-19", "2020-03-20", "2020-03-20", "2020-03-20",
        "2020-03-20", "2020-03-20", "2020-03-20", "2020-03-20", "2020-03-20",
        "2020-03-20", "2020-03-20", "2020-03-21", "2020-03-21",
        "2020-03-21", "2020-03-21", "2020-03-21", "2020-03-21", "2020-03-21",
        "2020-03-21", "2020-03-21", "2020-03-21", "2020-03-22",
        "2020-03-22", "2020-03-22", "2020-03-22", "2020-03-22", "2020-03-22",
        "2020-03-22", "2020-03-22", "2020-03-22", "2020-03-22",
        "2020-03-23", "2020-03-23", "2020-03-23", "2020-03-23", "2020-03-23",
        "2020-03-23", "2020-03-23", "2020-03-23", "2020-03-23",
        "2020-03-23", "2020-03-24", "2020-03-24", "2020-03-24", "2020-03-24",
        "2020-03-24", "2020-03-24", "2020-03-24", "2020-03-24",
        "2020-03-24", "2020-03-24", "2020-03-25", "2020-03-25", "2020-03-25",
        "2020-03-25", "2020-03-25", "2020-03-25", "2020-03-25",
        "2020-03-25", "2020-03-25", "2020-03-25", "2020-03-26", "2020-03-26",
        "2020-03-26", "2020-03-26", "2020-03-26", "2020-03-26",
        "2020-03-26", "2020-03-26", "2020-03-26", "2020-03-26"
    )),
    incidence = c(
        0, 0.25066660589899, 0.492142098234219,
        0.725072640028367, 0.950069365923764, 1.16771046349305,
        1.37854313503311, 1.58308544679162, 1.78182807217317, 1.97523593509314,
        2.1637497592906, 2.34778752907517, 2.52774586666609,
        2.70400133098351, 2.87691164247062, 3.04681683826081, 3.21404036175454,
        3.37889009043545, 3.54165930553423, 3.70262760694012,
        3.86206177656347, 4.02021659316803, 4.17733560151706, 4.33365183851354,
        4.48938851885987, 4.644759682617, 4.79997080690556,
        4.95521938386258, 5.1106954668454, 5.26658218675989, 5.42305624028218,
        5.58028835164107, 5.7384437095329, 5.89768238065011,
        6.05815970121984, 6.22002664786906, 6.38343018905682, 6.54851361824392,
        6.71541686990285, 6.88427681940811, 7.05522756778776,
        7.22840071226118, 7.4039256034353, 7.5819295899822, 7.7625382515744,
        7.94587562080998, 8.13206439481861, 8.32122613720066, 8.51348147091459,
        8.70895026269382, 8.90775179954135, 9.11000495782024,
        9.31582836542894, 9.52534055752367, 9.7386601262245, 9.9559058647176,
        10.177196906144, 10.4026528576438, 10.6323939299039,
        10.8665410625412, 11.1052160456318, 11.3485416376834, 11.5966416803305,
        11.8496412100191, 12.107666566931, 12.3708455013883,
        12.6393072779645, 12.913182777516, 13.1926045973412, 13.4777071496596,
        13.7686267585968, 14.0655017558517, 14.3684725752141,
        14.6776818460914, 14.9932744861999, 15.3153977935633, 15.6442015379618,
        15.9798380519618, 16.3224623216576, 16.6722320772452,
        17.0293078835483, 17.3938532306086, 17.7660346244504, 18.1460216781248,
        18.5339872031344, 18.9301073013382, 19.3345614574305,
        19.7475326320866, 20.1692073558655, 20.5997758239555, 21.0394319918485,
        21.4883736720256, 21.9468026317345, 22.4149246919387,
        22.892949827515, 23.3810922687765, 23.8795706043958, 24.3886078858019,
        24.9084317331239, 25.4392744427538, 25.9813730965994,
        26.5349696730975, 27.1003111600586, 27.677649669412, 28.2672425539212,
        28.8693525259384, 29.4842477782681, 30.1122021072073, 30.7534950378338,
        31.4084119516094, 32.07724421637, 32.7602893187702,
        33.4578509992544, 34.170239389624, 34.8977711532726, 35.6407696281603,
        36.3995649726006, 37.1744943139315, 37.9659019001466,
        38.7741392545596, 39.5995653335786, 40.4425466876662, 41.3034576255643,
        42.1826803818614, 43.0806052879817, 43.9976309466792,
        44.9341644101172, 45.8906213616173, 46.8674263011634, 47.8650127347469,
        48.8838233676406, 49.9243103016907, 50.9869352367186,
        52.072169676124, 53.1804951367841, 54.3124033633448, 55.4683965470018,
        56.6489875488701, 57.8547001280452, 59.0860691744573,
        60.3436409466255, 61.6279733144184, 62.9396360069311, 64.2792108655898,
        65.6472921025985, 67.0444865648433, 68.4714140033729,
        69.9287073485764, 71.4170129911814, 72.9369910691983, 74.4893157609391,
        76.0746755842413, 77.6937737020309, 79.3473282343611,
        81.0360725770653, 82.7607557271667, 84.5221426151892, 86.3210144445185,
        88.1581690379632, 90.0344211916708, 91.9506030365566,
        93.9075644074042, 95.9061732198043, 97.9473158550975, 100.031897553492,
        102.160842815532, 104.335095812095, 106.555620803096,
        108.823402565095, 111.139446827981, 113.504780720942, 115.920453227912,
        118.387535652695, 120.907122093972, 123.480329930415,
        126.108300316096, 128.792198686441, 131.533215274934, 134.332565640798,
        137.191491207906, 140.111259815139, 143.093166278449,
        146.138532964865, 149.248710378712, 152.425077760283, 155.669043697247,
        158.982046749048, 162.365556084582, 165.821072133436,
        169.350127250967, 172.954286397519, 176.635147832086, 180.394343820718,
        184.233541359993, 188.15444291586, 192.158787178202,
        196.24834983143, 200.424944341465, 204.690422759447, 209.046676542535
    ),
    t = c(
        0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8,
        0.9, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2, 2.1,
        2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 3, 3.1, 3.2, 3.3, 3.4,
        3.5, 3.6, 3.7, 3.8, 3.9, 4, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7,
        4.8, 4.9, 5, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 5.9, 6, 6.1,
        6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8, 6.9, 7, 7.1, 7.2, 7.3, 7.4,
        7.5, 7.6, 7.7, 7.8, 7.9, 8, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7,
        8.8, 8.9, 9, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 9.8, 9.9, 10,
        10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7, 10.8, 10.9, 11, 11.1,
        11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8, 11.9, 12, 12.1, 12.2,
        12.3, 12.4, 12.5, 12.6, 12.7, 12.8, 12.9, 13, 13.1, 13.2,
        13.3, 13.4, 13.5, 13.6, 13.7, 13.8, 13.9, 14, 14.1, 14.2, 14.3,
        14.4, 14.5, 14.6, 14.7, 14.8, 14.9, 15, 15.1, 15.2, 15.3, 15.4,
        15.5, 15.6, 15.7, 15.8, 15.9, 16, 16.1, 16.2, 16.3, 16.4, 16.5,
        16.6, 16.7, 16.8, 16.9, 17, 17.1, 17.2, 17.3, 17.4, 17.5, 17.6,
        17.7, 17.8, 17.9, 18, 18.1, 18.2, 18.3, 18.4, 18.5, 18.6, 18.7,
        18.8, 18.9, 19, 19.1, 19.2, 19.3, 19.4, 19.5, 19.6, 19.7,
        19.8, 19.9
    )
) |>
    left_join(
        incidence |> select(Date, Cases),
        by = c("day" = "Date")
    )

p <- ggplot(sir_model_fit) +
    geom_col(data = sir_model_fit |> filter(t == floor(t)), aes(x = day, y = Cases), fill = "#E74C3C", alpha = 0.6, width = 0.8) +
    geom_line(data = sir_model_fit, aes(x = day[1] + t, y = incidence), color = "#2C3E50", linewidth = 1.2) +
    geom_point(data = sir_model_fit |> filter(t == floor(t)), aes(x = day, y = Cases), color = "#E74C3C", size = 2) +
    geom_point(data = sir_model_fit |> filter(t == floor(t)), aes(x = day, y = incidence), color = "#2C3E50", size = 2) +
    geom_segment(
        data = sir_model_fit |> filter(t == floor(t)),
        aes(x = day, xend = day, y = Cases, yend = incidence),
        color = "gray40", linetype = "dashed"
    ) +
    labs(x = "Date", y = "Daily Incidence") +
    theme_minimal() +
    theme(plot.background = element_rect(fill = "white"))

print(p)